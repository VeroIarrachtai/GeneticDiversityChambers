---
title: "Ozono_concentration_chambers"
author: "Vero"
date: "28/10/2024"
output:
  html_document:
    toc: true
    toc_float: true
    theme: "yeti"
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries
```{r}
library(vcfR)
library(gdsfmt)
library(SNPRelate)
#library(related)
library(ggplot2)
library(pheatmap)
library(reshape2)
library("readxl")
library(factoextra)

```


# Load files
```{r}
info_GBS <- read.csv("../../SecuencingData/outputs/df_GBS_metadata.csv") 

# Mostrar las primeras filas del data frame
head(info_GBS)

```


```{r}

##### Obtener muestras

# Filtrar filas donde la columna reforested tenga el valor "yes"
info_GBS_refo <- info_GBS %>%
  filter(reforested == "yes")

# Filtrar filas donde la columna reforested tenga el valor "no"
info_GBS_natural <- info_GBS %>%
  filter(reforested == "no")


# Filtrar filas donde la columna condition tenga el valor "chambers"
info_GBS_chamber <- info_GBS %>%
  filter(person_key_GBS == "chamber")

write.table(info_GBS_chamber$Sample_Name_Plate, "../metadata/SamplesVCFChambers.txt", row.names = FALSE, col.names = FALSE, quote = FALSE)

# Filtrar filas donde la columna condition tenga el valor "mothers"
info_GBS_mother <- info_GBS %>%
  filter(Treatment == "actual_mother")


# Filtrar filas donde la columna condition tenga el valor "chambers"
info_GBS_transcriptomic <- info_GBS %>%
  filter(person_key_GBS == "transcriptomic")


# Exportar nombre de muestras para crear vcf

# Crear un vector con datos de ambas columnas
vector_refycham <- c(info_GBS_refo$Sample_Name_Plate, info_GBS_chamber$Sample_Name_Plate)

# Crear un vector con datos de ambas columnas
vector_natycham <- c(info_GBS_natural$Sample_Name_Plate, info_GBS_chamber$Sample_Name_Plate)

# Crear un vector con datos de ambas columnas
vector_motherycham <- c(info_GBS_mother$Sample_Name_Plate, info_GBS_chamber$Sample_Name_Plate)

# Crear un vector con datos de ambas columnas
vector_transmotcham <- c(info_GBS_transcriptomic$Sample_Name_Plate, info_GBS_mother$Sample_Name_Plate, info_GBS_chamber$Sample_Name_Plate)

# Crear un vector con datos de ambas columnas
vector_transmotrefcham <- c(info_GBS_transcriptomic$Sample_Name_Plate, info_GBS_mother$Sample_Name_Plate, info_GBS_refo$Sample_Name_Plate, info_GBS_chamber$Sample_Name_Plate)

# Crear un vector con datos de ambas columnas
vector_transmotnatcham <- c(info_GBS_transcriptomic$Sample_Name_Plate, info_GBS_mother$Sample_Name_Plate, info_GBS_natural$Sample_Name_Plate, info_GBS_chamber$Sample_Name_Plate)


# Crear un vector con datos de ambas columnas
vector_motrefcham <- c( info_GBS_mother$Sample_Name_Plate, info_GBS_refo$Sample_Name_Plate, info_GBS_chamber$Sample_Name_Plate)

# Crear un vector con datos de ambas columnas
vector_motnatcham <- c(info_GBS_mother$Sample_Name_Plate, info_GBS_natural$Sample_Name_Plate, info_GBS_chamber$Sample_Name_Plate)


```


```{r}


# Guardar el vector en un archivo de texto (en formato de texto plano)
write(vector_refycham, file = "../outputs/vectors_VCF/datos_vcf_refycham.txt")
write(vector_natycham, file = "../outputs/vectors_VCF/datos_vcf_vector_natycham.txt")
write(vector_motherycham, file = "../outputs/vectors_VCF/datos_vcf_motherycham.txt")
write(vector_transmotcham, file = "../outputs/vectors_VCF/datos_vcf_transmotcham.txt")
write(vector_transmotrefcham, file = "../outputs/vectors_VCF/datos_vcf_transmotrefcham.txt")
write(vector_transmotnatcham, file = "../outputs/vectors_VCF/datos_vcf_transmotnatcham.txt")
write(vector_motrefcham, file = "../outputs/vectors_VCF/datos_vcf_motrefcham.txt")
write(vector_motnatcham, file = "../outputs/vectors_VCF/datos_vcf_motnatcham.txt")

```




#anotaciones colores
```{r}
#
# Definir colores para los estados
ann_colors_surv <- list(Phenotype = c("dead_NA" = "black","survive_0" = "lightgreen", "survive_1" = "lightpink"))

# Definir colores para los estados
ann_colors_cham <- list(Chamber = c(
  "1" = "black",
  "2" = "green",
  "3" = "red",
  "4" = "blue",
  "5" = "purple",
  "6" = "orange",
  "7" = "pink",
  "8" = "brown",
  "9" = "cyan",
  "10" = "magenta",
  "11" = "yellow",
  "12" = "gray",
  "13" = "lightblue",
  "14" = "lightgreen",
  "15" = "lightpink"
))

# Definir colores para los estados
ann_colors_treatment <- list(Treatment = c("ambient_air_SRX" ="#697329",
                  "purified_air" ="#48b1da", 
                  "ambient_air_IE" ="#5cc051",  
                  "ozone_moderate" ="#bcb635", 
                  "ozone_contingency" ="#d3453a" ))


# Definir colores para cada anotación
ann_colors_mix <- list(
  Phenotype = c("dead_NA" = "black","survive_0" = "lightgreen", "survive_1" = "lightpink"), # Colores para Grupo
  Treatment =  c("ambient_air_SRX" ="#697329",
                 "purified_air" ="#48b1da", 
                  "ambient_air_IE" ="#5cc051",  
                  "ozone_moderate" ="#bcb635", 
                  "ozone_contingency" ="#d3453a" ) # Colores para Tratamiento
)

```


```{r}

# Cargar el archivo VCF
vcf <- read.vcfR("../data/all_GBS.vcf")

# Convertir a genlight
genlight_obj <- vcfR2genlight(vcf)

# Calcular matriz de relatedness
relatedness_matrix <- gl.grm(vcf, method = "IBS")  # IBS = Identity By State

# Ver la estructura de la matriz
print(relatedness_matrix)

relatedness_matrix <- dist(as.matrix(genlight_obj))



# Convertir la matriz en un formato de data frame
relatedness_df <- melt(as.matrix(relatedness_matrix))

# Renombrar columnas
colnames(relatedness_df) <- c("Ind1", "Ind2", "Relatedness")

ggplot(relatedness_df, aes(Ind1, Ind2, fill = Relatedness)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +  # Puedes cambiar los colores
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Heatmap de Relatedness", fill = "Índice de Relatedness")


# Convertir la matriz en un formato adecuado para ggplot
library(reshape2)  # Para reorganizar los datos
dist_df <- melt(as.matrix(relatedness_matrix))

# Crear el heatmap con ggplot
ggplot(dist_df, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "blue", high = "red") +  # Colores personalizables
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Heatmap de Distancia Genética", fill = "Distancia")




gl.plot.heatmap(genlight_obj)
```




```{r}


```



```{r}

```



```{r}

```



```{r}

```



```{r}

```

























# TMNC 

### Convertir VCF a formato GDS
```{r}
#Incluye muestras de transcriptomica, muestras madre, muestras de regeneracion natural y las camaras
vcf_GBS.fn <- "../data/all_GBS.vcf"
gds_GBS.fn <- "GBS.gds"
snpgdsVCF2GDS(vcf_GBS.fn, gds_GBS.fn, method="biallelic.only")

# Abrir archivo GDS
genofileGBS <- snpgdsOpen(gds_GBS.fn)
```





































#LOAD LIBRARIES
```{r}
#Load libraries
library(openxlsx)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggpubr)
library(car)
library(MASS)
```

























```{r }



#Distribución Exponencial o Gamma (Gamma): Si los datos son continuos, no negativos, y asimétricos (con cola a la derecha).

#delta_altura = cambio de altura antes y despues del Tratamiento con dosis de ozono
#ozone_damage = Fenotipo Sintomatico o Asintomatico antes y despues del Tratamiento con dosis de ozono
#Treatment = Dosis de ozono a la que se expusieron los arboles por 3 meses
#GroupMatrix = Grupo genetico al que se asociaron de acuerdo a un analisis de parentesco
#ChamberNumber = se refiere a la camara en la que se encontraban los arboles, cada tratamiento tenia 3 diferentes

df_JunDel_2allAP <- df_JunDel_2Rel %>%
  filter(treatment != "purified_air")       

model1 <- glm(delta_altura ~ ozone_damage, data = df_JunDel_2allAP, family = Gamma(link = "log"))
summary(model1)

model2 <- glm(delta_altura ~ ozone_damage + treatment, data = df_JunDel_2allAP, family = Gamma(link = "log"))
summary(model2)


model3 <- glmer(delta_altura ~ ozone_damage + treatment  + (1|treatment) , data = df_JunDel_2allAP, family = Gamma(link = "log"))
summary(model3)



# Comparar los AIC de los dos modelos
AIC(model1, model2, model3)


```




# Plot modelo per RELATEDNESS/DeltaAltura P3



```{r }

df_GroupsMatrix <- read.table("../metadata/df_GroupsMatrix.txt", header = TRUE, sep = "", stringsAsFactors = FALSE)
df_GroupsMatrixP3 <- df %>% filter(GroupMatrix %in% c("P3_groupA", "P3_groupB", "P3_groupC", "P3_groupD"))

df_JunDel_2Rel <- df_JunDel_2

# Unir df_Jun con Matrix usando la columna ID
df_JunDel_2Rel <- merge(df_JunDel_2Rel, df_GroupsMatrixP3[, c("ID", "GroupMatrix")], by = "ID", all.x = TRUE)

# Reemplazar los valores NA con "No_exposed_ozone"
df_JunDel_2Rel$GroupMatrix[is.na(df_JunDel_2Rel$GroupMatrix)] <- "No_sequenced"


# df_JunDel_2Rel <- df_JunDel_2Rel %>%
#  mutate(
 #   GroupMatrix = case_when(
  #    is.na(GroupMatrix) & treatment == "purified_air" ~ "Dosis_purified_air",
   #   is.na(GroupMatrix) & treatment != "purified_air" ~ "No_sequenced",
    #  TRUE ~ GroupMatrix  # Mantiene los valores originales si no se cumplen las condiciones
    #)
  #)


# Ver el resultado
head(df_JunDel_2Rel)

```



```{r }

stat_box_data <- function(y) {
  return( 
    data.frame(
      y = 0.5+1.1*max(y),  
      label = paste('n =', length(y))
    )
  )
}

df_JunDel_2Rel <- df_JunDel_2Rel %>% 
  filter(!treatment %in% c( "ambient_air_SRX"))%>%  # Filtrar antes de eliminar duplicados
  distinct(ID, .keep_all = TRUE)  # Mantiene la primera ocurrencia y elimina duplicados




ggplot(df_JunDel_2Rel, aes(x = as.factor(ozone_damage), y = delta_altura, 
                           fill = as.factor(ozone_damage))) +  # Diferenciar boxplots por síntoma
  geom_boxplot(alpha = 0.5, color = "black") +  # Boxplot con bordes negros
  geom_jitter(aes(shape = as.factor(GroupMatrix)),  # Agregar puntos con shapes
              position = position_jitter(width = 0.2), 
              size = 4, alpha = 0.8) +  
  facet_wrap(~ treatment, labeller = labeller(treatment = c("purified_air" = "purified air", "ambient_air_IE" = "ambient air UNAM",
                      "ozone_moderate" ="moderate", "ozone_contingency" = "contingency"))) +  
  stat_summary(
    fun.data = stat_box_data, 
    geom = "text", 
    position = position_dodge(width = 0.75), 
    hjust = 0.5,
    vjust = 0.5, 
    size = 6)+
  labs(title = "",
       x = "Condition after treatment",
       y = "Δ height (cm)") +
  scale_fill_manual(values = c("0" = "white", "1" = "#7962cb"), 
                    labels = c("Assymptomatic", "Symptomatic")) +  # Colores para los boxplots
  scale_shape_manual(values = shape_GroupsMatrix) +  # Formas para GroupMatrix
  guides(shape = guide_legend(title = "Relatedness Group"),
          fill = guide_legend(title = "Condition after treatment") ) +  # Leyenda para shape
  theme_bw() +
  theme(
    axis.text.x = element_blank(),  # Tamaño del texto del eje X
    axis.text.y = element_text(size = 25),                        # Tamaño del texto del eje Y
    legend.title = element_text(size = 25),                       # Tamaño del título de la leyenda
    legend.text = element_text(size = 20),                        # Tamaño del texto de la leyenda
    axis.title.y = element_text(size = 20),
    legend.title.align = 0.5,
    legend.position = "right",
    text = element_text(size = 20),
    plot.title = element_text(lineheight = 1.1))


# Export image# Export imagecolors_woSRX
ggsave("../outputs/model_per_ozone-damage-treatment-Group.png", width = 16, height = 10, dpi = 600)

```

# Plot modelo per RELATEDNESS/DeltaAltura P4

```{r }

df_GroupsMatrix <- read.table("../metadata/df_GroupsMatrix.txt", header = TRUE, sep = "", stringsAsFactors = FALSE)
df_GroupsMatrixP4 <- df %>% filter(GroupMatrix %in% c("P4_groupA", "P4_groupB", "P4_groupC", "P4_groupD", "P4_groupE"))

df_JunDel_2Rel <- df_JunDel_2

# Unir df_Jun con Matrix usando la columna ID
df_JunDel_2Rel <- merge(df_JunDel_2Rel, df_GroupsMatrixP4[, c("ID", "GroupMatrix")], by = "ID", all.x = TRUE)

# Reemplazar los valores NA con "No_exposed_ozone"
df_JunDel_2Rel$GroupMatrix[is.na(df_JunDel_2Rel$GroupMatrix)] <- "No_sequenced"


# df_JunDel_2Rel <- df_JunDel_2Rel %>%
#  mutate(
 #   GroupMatrix = case_when(
  #    is.na(GroupMatrix) & treatment == "purified_air" ~ "Dosis_purified_air",
   #   is.na(GroupMatrix) & treatment != "purified_air" ~ "No_sequenced",
    #  TRUE ~ GroupMatrix  # Mantiene los valores originales si no se cumplen las condiciones
    #)
  #)


# Ver el resultado
head(df_JunDel_2Rel)

```



```{r }

stat_box_data <- function(y) {
  return( 
    data.frame(
      y = 0.5+1.1*max(y),  
      label = paste('n =', length(y))
    )
  )
}

df_JunDel_2Rel <- df_JunDel_2Rel %>% 
  filter(!treatment %in% c( "ambient_air_SRX")) %>%  # Filtrar antes de eliminar duplicados
  distinct(ID, .keep_all = TRUE)  # Mantiene la primera ocurrencia y elimina duplicados



ggplot(df_JunDel_2Rel, aes(x = as.factor(ozone_damage), y = delta_altura, 
                           fill = as.factor(ozone_damage))) +  # Diferenciar boxplots por síntoma
  geom_boxplot(alpha = 0.5, color = "black") +  # Boxplot con bordes negros
  geom_jitter(aes(shape = as.factor(GroupMatrix)),  # Agregar puntos con shapes
              position = position_jitter(width = 0.2), 
              size = 4, alpha = 0.8) +  
  facet_wrap(~ treatment, labeller = labeller(treatment = c("purified_air" = "purified air", "ambient_air_IE" = "ambient air UNAM",
                      "ozone_moderate" ="moderate", "ozone_contingency" = "contingency"))) +  
  stat_summary(
    fun.data = stat_box_data, 
    geom = "text", 
    position = position_dodge(width = 0.75), 
    hjust = 0.5,
    vjust = 0.5, 
    size = 6)+
  labs(title = "",
       x = "Condition after treatment",
       y = "Δ height (cm)") +
  scale_fill_manual(values = c("0" = "white", "1" = "#7962cb"), 
                    labels = c("Assymptomatic", "Symptomatic")) +  # Colores para los boxplots
  scale_shape_manual(values = shape_GroupsMatrix) +  # Formas para GroupMatrix
  guides(shape = guide_legend(title = "Relatedness Group"),
          fill = guide_legend(title = "Condition after treatment") ) +  # Leyenda para shape
  theme_bw() +
  theme(
    axis.text.x = element_blank(),  # Tamaño del texto del eje X
    axis.text.y = element_text(size = 25),                        # Tamaño del texto del eje Y
    legend.title = element_text(size = 25),                       # Tamaño del título de la leyenda
    legend.text = element_text(size = 20),                        # Tamaño del texto de la leyenda
    axis.title.y = element_text(size = 20),
    legend.title.align = 0.5,
    legend.position = "right",
    text = element_text(size = 20),
    plot.title = element_text(lineheight = 1.1))


# Export image# Export imagecolors_woSRX
ggsave("../outputs/model_per_ozone-damage-treatment-Group.png", width = 16, height = 10, dpi = 600)

```


# Plot modelo per RELATEDNESS/DeltaAltura P4 y grupo de P3

```{r }

df_GroupsMatrix <- read.table("../metadata/df_GroupsMatrix.txt", header = TRUE, sep = "", stringsAsFactors = FALSE)
df_GroupsMatrixPmix <- df %>% filter(GroupMatrix %in% c("P4_groupA", "P4_groupB", "P4_groupC", "P4_groupD", "P4_groupE",  "P3_groupC"))

df_JunDel_2Rel <- df_JunDel_2

# Unir df_Jun con Matrix usando la columna ID
df_JunDel_2Rel <- merge(df_JunDel_2Rel, df_GroupsMatrixPmix[, c("ID", "GroupMatrix")], by = "ID", all.x = TRUE)

# Reemplazar los valores NA con "No_exposed_ozone"
df_JunDel_2Rel$GroupMatrix[is.na(df_JunDel_2Rel$GroupMatrix)] <- "No_sequenced"


# df_JunDel_2Rel <- df_JunDel_2Rel %>%
#  mutate(
 #   GroupMatrix = case_when(
  #    is.na(GroupMatrix) & treatment == "purified_air" ~ "Dosis_purified_air",
   #   is.na(GroupMatrix) & treatment != "purified_air" ~ "No_sequenced",
    #  TRUE ~ GroupMatrix  # Mantiene los valores originales si no se cumplen las condiciones
    #)
  #)


# Ver el resultado
head(df_JunDel_2Rel)

```


```{r }

stat_box_data <- function(y) {
  return( 
    data.frame(
      y = 0.5+1.1*max(y),  
      label = paste('n =', length(y))
    )
  )
}

df_JunDel_2Rel <- df_JunDel_2Rel %>% filter(!treatment %in% c( "ambient_air_SRX"))

df_JunDel_2Rel$GroupMatrix


# Filtrar el data frame para eliminar las filas con "No_sequenced" en GroupMatrix
# Eliminar duplicados basados en la columna ID

df_JunDel_2Rel_filtrado <- df_JunDel_2Rel %>%
  filter(GroupMatrix != "No_sequenced") %>%  # Filtrar antes de eliminar duplicados
  distinct(ID, .keep_all = TRUE)  # Mantiene la primera ocurrencia y elimina duplicados

df_JunDel_2Rel_filtrado <- df_JunDel_2Rel_filtrado %>%
  mutate(GroupMatrix = case_when(
    GroupMatrix %in% c("P3_groupC", "P4_groupD") ~ "P4DyP3C",
    TRUE ~ GroupMatrix  # Mantiene los demás valores sin cambios
  ))



ggplot(df_JunDel_2Rel_filtrado, aes(x = as.factor(ozone_damage), y = delta_altura, 
                           fill = as.factor(ozone_damage))) +  # Diferenciar boxplots por síntoma
  geom_boxplot(alpha = 0.5, color = "black") +  # Boxplot con bordes negros
  geom_jitter(aes(shape = as.factor(GroupMatrix)),  # Agregar puntos con shapes
              position = position_jitter(width = 0.2), 
              size = 4, alpha = 0.8) +  
  facet_wrap(~ treatment, labeller = labeller(treatment = c("purified_air" = "purified air", "ambient_air_IE" = "ambient air UNAM",
                      "ozone_moderate" ="moderate", "ozone_contingency" = "contingency"))) +  
  stat_summary(
    fun.data = stat_box_data, 
    geom = "text", 
    position = position_dodge(width = 0.75), 
    hjust = 0.5,
    vjust = 0.5, 
    size = 6)+
  labs(title = "",
       x = "Condition after treatment",
       y = "Δ height (cm)") +
  scale_fill_manual(values = c("0" = "white", "1" = "#7962cb"), 
                    labels = c("Assymptomatic", "Symptomatic")) +  # Colores para los boxplots
  scale_shape_manual(values = shape_GroupsMatrixMix) +  # Formas para GroupMatrix
  guides(shape = guide_legend(title = "Relatedness Group"),
          fill = guide_legend(title = "Condition after treatment") ) +  # Leyenda para shape
  theme_bw() +
  theme(
    axis.text.x = element_blank(),  # Tamaño del texto del eje X
    axis.text.y = element_text(size = 25),                        # Tamaño del texto del eje Y
    legend.title = element_text(size = 25),                       # Tamaño del título de la leyenda
    legend.text = element_text(size = 20),                        # Tamaño del texto de la leyenda
    axis.title.y = element_text(size = 20),
    legend.title.align = 0.5,
    legend.position = "right",
    text = element_text(size = 20),
    plot.title = element_text(lineheight = 1.1))


# Export image# Export imagecolors_woSRX
ggsave("../outputs/model_per_ozone-damage-treatment-Groupmix.png", width = 16, height = 10, dpi = 600)

```



# Plot samples RELATEDNESS/DeltaAltura P3yP4 same assambly

```{r }
#Load data Grupos Geneticos
df_GroupsMatrix <- read.table("../metadata/df_GroupsMatrixP3y4.txt", header = TRUE, sep = "", stringsAsFactors = FALSE)

df_GroupsMatrixPmix <- df_GroupsMatrix %>% filter(GroupMatrix %in% c("P3y4_groupA", "P3y4_groupB", "P3y4_groupC", "P3y4_groupD", "P3y4_groupE", "P3y4_groupF"))

df_JunDel_2Rel <- df_JunDel_2

# Unir df_Jun con Matrix usando la columna ID
df_JunDel_2Rel <- merge(df_JunDel_2Rel, df_GroupsMatrixPmix[, c("ID", "GroupMatrix")], by = "ID", all.x = TRUE)

# Reemplazar los valores NA con "No_exposed_ozone"
df_JunDel_2Rel$GroupMatrix[is.na(df_JunDel_2Rel$GroupMatrix)] <- "No_sequenced"


# df_JunDel_2Rel <- df_JunDel_2Rel %>%
#  mutate(
 #   GroupMatrix = case_when(
  #    is.na(GroupMatrix) & treatment == "purified_air" ~ "Dosis_purified_air",
   #   is.na(GroupMatrix) & treatment != "purified_air" ~ "No_sequenced",
    #  TRUE ~ GroupMatrix  # Mantiene los valores originales si no se cumplen las condiciones
    #)
  #)


# Ver el resultado
head(df_JunDel_2Rel)

```


```{r }

stat_box_data <- function(y) {
  return( 
    data.frame(
      y = 0.5+1.1*max(y),  
      label = paste('n =', length(y))
    )
  )
}

df_JunDel_2Rel <- df_JunDel_2Rel %>% filter(!treatment %in% c( "ambient_air_SRX"))

df_JunDel_2Rel$GroupMatrix


# Filtrar el data frame para eliminar las filas con "No_sequenced" en GroupMatrix
# Eliminar duplicados basados en la columna ID

df_JunDel_2Rel_filtrado <- df_JunDel_2Rel %>%
  filter(!GroupMatrix %in% c("No_sequenced", "P3y4_groupF")) %>%  # Filtrar antes de eliminar duplicados
  distinct(ID, .keep_all = TRUE)  # Mantiene la primera ocurrencia y elimina duplicados




ggplot(df_JunDel_2Rel_filtrado, aes(x = as.factor(ozone_damage), y = delta_altura, 
                           fill = as.factor(ozone_damage))) +  # Diferenciar boxplots por síntoma
  geom_boxplot(alpha = 0.5, color = "black") +  # Boxplot con bordes negros
  geom_jitter(aes(shape = as.factor(GroupMatrix)),  # Agregar puntos con shapes
              position = position_jitter(width = 0.2), 
              size = 4, alpha = 0.8) +  
  facet_wrap(~ treatment, labeller = labeller(treatment = c("purified_air" = "purified air", "ambient_air_IE" = "ambient air UNAM","ozone_moderate" ="moderate", "ozone_contingency" = "contingency"))) +  
  stat_summary(
    fun.data = stat_box_data, 
    geom = "text", 
    position = position_dodge(width = 0.75), 
    hjust = 0.5,
    vjust = 0.5, 
    size = 6)+
  labs(title = "",
       x = "",
       y = "Δ height (cm)") +
  scale_fill_manual(values = c("0" = "white", "1" = "#7962cb"), 
                    labels = c("Assymptomatic", "Symptomatic")) +  # Colores para los boxplots
  scale_x_discrete(labels = c("0" = "Assymptomatic", "1" = "Symptomatic")) +  # Cambiar etiquetas del eje X
  scale_shape_manual(values = shape_GroupsMatrixP3y4) +  # Formas para GroupMatrix
  guides(shape = guide_legend(title = "Relatedness Group"),
          fill = "none" ) +  # Leyenda para shape
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 25),   # Tamaño del texto del eje X
    axis.text.y = element_text(size = 25),                        # Tamaño del texto del eje Y
    legend.title = element_text(size = 25),                       # Tamaño del título de la leyenda
    legend.text = element_text(size = 20),                        # Tamaño del texto de la leyenda
    axis.title.y = element_text(size = 20),
    legend.title.align = 0.5,
    legend.position = "right",
    text = element_text(size = 20),
    plot.title = element_text(lineheight = 1.1))


# Export image# Export imagecolors_woSRX
ggsave("../outputs/model_per_ozone-damage-treatment-GroupP3y4.png", width = 16, height = 10, dpi = 600)

```



## Plot samples RELATEDNESS/Clorofila P3yP4 same assambly


```{r }

df_mergeRel<- df_merge

# Unir df_Jun con Matrix usando la columna ID
df_mergeRel <- merge(df_mergeRel, df_GroupsMatrixPmix[, c("ID", "GroupMatrix")], by = "ID", all.x = TRUE)

# Reemplazar los valores NA con "No_exposed_ozone"
df_mergeRel$GroupMatrix[is.na(df_mergeRel$GroupMatrix)] <- "No_sequenced"

# Ver el resultado
head(df_mergeRel)

```

```{r }
stat_box_data <- function(y) {
  return( 
    data.frame(
      y = 0.5+1.1*max(y),  
      label = paste('n =', length(y))
    )
  )
}


# Filtrar el data frame para eliminar las filas con "No_sequenced" en GroupMatrix
# Eliminar duplicados basados en la columna ID

#df_mergeRel_filtrado <- df_mergeRel %>%
 # filter(GroupMatrix != "No_sequenced") %>%  # Filtrar antes de eliminar duplicados
  #distinct(ID, .keep_all = TRUE)  # Mantiene la primera ocurrencia y elimina duplicados

df_mergeRel_filtrado <- df_mergeRel %>%
  filter(!GroupMatrix %in% c("No_sequenced", "P3y4_groupF")) %>%  # Filtrar antes de eliminar duplicados
  distinct(ID, .keep_all = TRUE)  # Mantiene la primera ocurrencia y elimina duplicados



df_mergeRel_filtrado <- df_mergeRel_filtrado %>%
  mutate(GroupMatrix = case_when(
    GroupMatrix %in% c("P3_groupC", "P4_groupD") ~ "P4DyP3C",
    TRUE ~ GroupMatrix  # Mantiene los demás valores sin cambios
  ))


ggplot(df_mergeRel_filtrado, aes(x = as.factor(ozone_damage), y = Promedio_Clorofila, 
                           fill = as.factor(ozone_damage))) +  # Diferenciar boxplots por síntoma
  geom_boxplot(alpha = 0.5, color = "black") +  # Boxplot con bordes negros
  geom_jitter(aes(shape = as.factor(GroupMatrix)),  # Agregar puntos con shapes
              position = position_jitter(width = 0.2), 
              size = 4, alpha = 0.8) +  
  facet_wrap(~ treatment, labeller = labeller(treatment = c("purified_air" = "purified air", "ambient_air_IE" = "ambient air UNAM", "ozone_moderate" ="moderate", "ozone_contingency" = "contingency"))) +  
  stat_summary(
    fun.data = stat_box_data, 
    geom = "text", 
    position = position_dodge(width = 0.75), 
    hjust = 0.5,
    vjust = 0.5, 
    size = 6)+
  labs(title = "",
       x = "",
       y = "Total Chlorophyll (mg/g)") +
  scale_fill_manual(values = c("0" = "white", "1" = "#7962cb"), 
                    labels = c("Assymptomatic", "Symptomatic")) +  # Colores para los boxplots
  scale_x_discrete(labels = c("0" = "Assymptomatic", "1" = "Symptomatic")) +  # Cambiar etiquetas del eje X
  scale_shape_manual(values = shape_GroupsMatrixP3y4) +  # Formas para GroupMatrix
  guides(shape = guide_legend(title = "Relatedness Group"),
          fill = "none" ) +  # Leyenda para shape
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 25), # Tamaño del texto del eje X
    axis.text.y = element_text(size = 25),                        # Tamaño del texto del eje Y
    legend.title = element_text(size = 25),                       # Tamaño del título de la leyenda
    legend.text = element_text(size = 20),                        # Tamaño del texto de la leyenda
    axis.title.y = element_text(size = 20),
    legend.title.align = 0.5,
    legend.position = "right",
    text = element_text(size = 20),
    plot.title = element_text(lineheight = 1.1))


# Export image# Export imagecolors_woSRX
ggsave("../outputs/model_Cloro_P3y4.png", width = 16, height = 10, dpi = 600)

```
# Modelo

```{r }

# Load data
#df_merge_2 <- df_merge %>% filter(!treatment %in% c("ambient_air_SRX"))

#¿Que distribución tienen mis datos?

# Histograma
hist(df_JunDel_2Rel_filtrado$delta_altura, main="Histograma", xlab="Valores", col="lightblue", border="black")

summary(df_JunDel_2Rel_filtrado$delta_altura)



shapiro_test <- shapiro.test(df_JunDel_2Rel_filtrado$delta_altura)
print(shapiro_test)

#Dado que el p-value es menor que 0.05, se rechaza la hipótesis nula. Esto significa que hay evidencia estadística suficiente para concluir que los datos no siguen una distribución normal

#Borrar
rm(shapiro_test)

hist(log(df_JunDel_2Rel_filtrado$delta_altura), main="Histograma", xlab="Valores", col="lightblue", border="black")






# Histograma
hist(df_mergeRel_filtradoSRX$Promedio_Clorofila, main="Histograma", xlab="Valores", col="lightblue", border="black")

summary(df_mergeRel_filtradoSRX$Promedio_Clorofila)



shapiro_test <- shapiro.test(df_mergeRel_filtradoSRX$Promedio_Clorofila)
print(shapiro_test)

#Dado que el p-value es menor que 0.05, se rechaza la hipótesis nula. Esto significa que hay evidencia estadística suficiente para concluir que los datos no siguen una distribución normal

#Los datos tienen distribucion normal 
```


```{r }


df_mergeRel_filtradoSRX <- df_mergeRel_filtrado %>% filter(treatment != "ambient_air_SRX")

df_mergeRel_filtradoSRX$GroupMatrix

df_mergeRel_filtradoSRX$treatment <- droplevels(df_mergeRel_filtradoSRX$treatment)

df_mergeRel_filtradoSRX <- df_mergeRel_filtrado %>% filter(ID != c("AE22_N04TAF", "AP12_N04TAF"))
                                                           


```
#Modelo delta Altura 


```{r }

model1_gamma <- glm(delta_altura ~ ozone_damage, data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
model1_gaussian <- glm(delta_altura ~ ozone_damage, data = df_JunDel_2Rel_filtrado, family = gaussian(link = "identity"))

# Comparar AIC de los modelos
AIC(model1_gamma, model1_gaussian)
```


```{r }

#Distribución Exponencial o Gamma (Gamma): Si los datos son continuos, no negativos, y asimétricos.

#delta_altura = cambio de altura antes y despues del Tratamiento con dosis de ozono
#ozone_damage = Fenotipo Sintomatico o Asintomatico antes y despues del Tratamiento con dosis de ozono
#Treatment = Dosis de ozono a la que se expusieron los arboles por 3 meses
#GroupMatrix = Grupo genetico al que se asociaron de acuerdo a un analisis de parentesco
#ChamberNumber = se refiere a la camara en la que se encontraban los arboles, cada tratamiento tenia 3 diferentes


# Convertir ozone_damage a factor (si es apropiado tratarlo como categoría)
het_dataNSGG4AP$ozone_damage <- factor(het_dataNSGG4AP$ozone_damage)

# Crear el gráfico
g0 <- ggplot(het_dataNSGG4AP, aes(x = H_obs, y = delta_altura))

fig5all <- g0 + 
  geom_point(aes(colour = ozone_damage, shape = ozone_damage), alpha = 0.5, size = 2.5) + 
  ylim(0, 22) + 
  geom_smooth(method = "glm", method.args = list(family = Gamma(link = "log")), aes(color = ozone_damage), fullrange = T) + 
  labs(x = "Heterocigosity", y = "Delta height") + 
  theme_bw()

fig5all

```


```{r }



#Distribución Exponencial o Gamma (Gamma): Si los datos son continuos, no negativos, y asimétricos (con cola a la derecha).

#delta_altura = cambio de altura antes y despues del Tratamiento con dosis de ozono
#ozone_damage = Fenotipo Sintomatico o Asintomatico antes y despues del Tratamiento con dosis de ozono
#Treatment = Dosis de ozono a la que se expusieron los arboles por 3 meses
#GroupMatrix = Grupo genetico al que se asociaron de acuerdo a un analisis de parentesco
#ChamberNumber = se refiere a la camara en la que se encontraban los arboles, cada tratamiento tenia 3 diferentes

      
model1 <- glm(delta_altura ~ ozone_damage, data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model1)

model2 <- glm(delta_altura ~ ozone_damage + treatment, data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model2)

model3 <- glm(delta_altura ~ ozone_damage +  GroupMatrix, data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model3)

model4 <- glm(delta_altura ~ ozone_damage + treatment + GroupMatrix, data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model4)

model5 <- glmer(delta_altura ~ ozone_damage + treatment + GroupMatrix + (1|GroupMatrix) , data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model5)

model5 <- glmer(delta_altura ~ ozone_damage + treatment + GroupMatrix + (1|treatment) , data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model5)


model6 <- glmer(delta_altura ~ ozone_damage + treatment  + (1|treatment) , data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model6)


model7 <- glmer(delta_altura ~ ozone_damage + treatment + (1|GroupMatrix/treatment) , data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model7)

model8 <- glmer(delta_altura ~ ozone_damage + treatment + (1|GroupMatrix), data = df_JunDel_2Rel_filtrado, family = Gamma(link = "log"))
summary(model8)



# Comparar los AIC de los dos modelos
AIC(model1, model2, model3, model4, model5, model6, model7, model8)


```


#Modelo delta Altura SIN purificados

```{r }
df_JunDel_2Rel_filtradoAP <- df_JunDel_2Rel_filtrado %>%
  filter(treatment != "purified_air")                             

hist(df_JunDel_2Rel_filtradoAP$delta_altura, main="Histograma", xlab="Valores", col="lightblue", border="black")

#Distribución Exponencial o Gamma (Gamma): Si los datos son continuos, no negativos, y asimétricos (con cola a la derecha).

#delta_altura = cambio de altura antes y despues del Tratamiento con dosis de ozono
#ozone_damage = Fenotipo Sintomatico o Asintomatico antes y despues del Tratamiento con dosis de ozono
#Treatment = Dosis de ozono a la que se expusieron los arboles por 3 meses
#GroupMatrix = Grupo genetico al que se asociaron de acuerdo a un analisis de parentesco
#ChamberNumber = se refiere a la camara en la que se encontraban los arboles, cada tratamiento tenia 3 diferentes

      
model1 <- glm(delta_altura ~ ozone_damage, data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model1)

model2 <- glm(delta_altura ~ ozone_damage + treatment, data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model2)

model3 <- glm(delta_altura ~ ozone_damage +  GroupMatrix, data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model3)

model4 <- glm(delta_altura ~ ozone_damage + treatment + GroupMatrix, data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model4)

model5 <- glmer(delta_altura ~ ozone_damage + treatment + GroupMatrix + (1|GroupMatrix) , data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model5)

model5 <- glmer(delta_altura ~ ozone_damage + treatment + GroupMatrix + (1|treatment) , data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model5)


model6 <- glmer(delta_altura ~ ozone_damage + treatment  + (1|treatment) , data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model6)


model7 <- glmer(delta_altura ~ ozone_damage + treatment + (1|GroupMatrix/treatment) , data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model7)

model8 <- glmer(delta_altura ~ ozone_damage + treatment + (1|GroupMatrix), data = df_JunDel_2Rel_filtradoAP, family = Gamma(link = "log"))
summary(model8)



# Comparar los AIC de los dos modelos
AIC(model1, model2, model3, model4, model5, model6, model7, model8)

```





#CLOROFILA

```{r }
library(lme4)
library(lmerTest)

#Distribución Exponencial o Gamma (Gamma): Si los datos son continuos, no negativos, y asimétricos (con cola a la derecha).

#delta_altura = cambio de altura antes y despues del Tratamiento con dosis de ozono
#ozone_damage = Fenotipo Sintomatico o Asintomatico antes y despues del Tratamiento con dosis de ozono
#Treatment = Dosis de ozono a la que se expusieron los arboles por 3 meses
#GroupMatrix = Grupo genetico al que se asociaron de acuerdo a un analisis de parentesco
#ChamberNumber = se refiere a la camara en la que se encontraban los arboles, cada tratamiento tenia 3 diferentes


model1 <- glmer(Promedio_Clorofila ~ ozone_damage + treatment + GroupMatrix + (1|GroupMatrix), data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model1)

model2 <- glmer(Promedio_Clorofila ~ ozone_damage + GroupMatrix + (1|GroupMatrix) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model2)

model3 <- glmer(Promedio_Clorofila ~ ozone_damage + (1|GroupMatrix), data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model3)

model4 <- glmer(Promedio_Clorofila~ ozone_damage + treatment + GroupMatrix + (1|GroupMatrix/chamber_number) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model4)

# Creo es el mejor
model5 <- glmer(Promedio_Clorofila ~ ozone_damage + GroupMatrix + (1|GroupMatrix/chamber_number) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model5)

model6 <- glmer(Promedio_Clorofila ~ ozone_damage + (1|GroupMatrix/chamber_number) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model6)

model7 <- glmer(Promedio_Clorofila ~ ozone_damage + treatment + GroupMatrix + (1|GroupMatrix/treatment) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model7)

model8 <- glmer(Promedio_Clorofila ~ ozone_damage + GroupMatrix + (1|GroupMatrix/treatment) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model8)

# Segundo mejor
model9 <- glmer(Promedio_Clorofila ~ ozone_damage + (1|GroupMatrix/treatment) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model9)

model10 <- glmer(Promedio_Clorofila ~ ozone_damage + treatment + GroupMatrix + (1|GroupMatrix) + (1|treatment) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model10)

model11 <- glmer(Promedio_Clorofila ~ ozone_damage + GroupMatrix + (1|GroupMatrix) + (1|treatment) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model11)

model12 <- glmer(Promedio_Clorofila ~ ozone_damage + treatment + GroupMatrix + (1|treatment/GroupMatrix) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model12)

model13 <- glmer(Promedio_Clorofila ~ ozone_damage + GroupMatrix + (1|treatment/GroupMatrix) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model13)

# Segundo mejor
model14 <- glmer(Promedio_Clorofila ~ ozone_damage + (1|treatment/GroupMatrix) , data = df_mergeRel_filtradoSRX, family = Gamma(link = "log"))
summary(model14)

# Comparar los AIC de los dos modelos
AIC(model1, model2, model3, model4, model5, model6, model7, model8, model9, model10, model11, model12, model13, model14)

# Summaries
summary(model1)
summary(model2)
summary(model3)
summary(model4)
summary(model5) 
summary(model6)
summary(model7)
summary(model8) 
summary(model9)
summary(model10) 
summary(model11)
summary(model12)
summary(model13) 
summary(model14)


```

# Calcular HETEROCIGOSIDAD


```{r }
# Leer el archivo .het
het_data <- read.table("../metadata/heterocigosidad.het", header = TRUE)

# Cambiar el nombre de la columna 'IND' por 'ID'
colnames(het_data)[colnames(het_data) == "INDV"] <- "ID"

# Verificar que se cambió el nombre
head(het_data)


# Calcular la heterocigosidad observada
het_data$H_obs <- 1 - (het_data$O.HOM / het_data$N_SITES)

# Ver los resultados
head(het_data)

```


```{r }
# Calcular la heterocigosidad observada
het_data$H_obs <- 1 - (het_data$O.HOM / het_data$N_SITES)

# Ver los resultados
head(het_data)

```


```{r }
# Histograma de la heterocigosidad observada
hist(het_data$H_obs, 
     main = "Distribución deHeterocigosidad por Individuo de Seq y No Seq de 4 tratamientos", 
     xlab = "Heterocigosidad Observada", 
     col = "lightblue", 
     border = "blue")
```


```{r }

# Gráfico de dispersión de heterocigosidad por individuo
plot(het_data$H_obs, 
     main = "Heterocigosidad por Individuo de Seq y No Seq de 4 tratamientos", 
     xlab = "Individuo", 
     ylab = "Heterocigosidad Observada", 
     pch = 16, 
     col = "blue")

```

```{r }
summary(het_data$H_obs)
```

```{r }

# Combinar el DataFrame de heterocigosidad con el DataFrame de fenotipos
het_data <- merge(het_data, df_JunDel_2Rel, by = "ID")

# Ver los primeros registros del DataFrame combinado
head(het_data)


het_dataNSGG4 <- het_data %>%
  filter(GroupMatrix != "No_sequenced" & GroupMatrix != "P3y4_groupF")

```


```{r }
# Graficar la heterocigosidad observada por fenotipo
boxplot(H_obs ~ ozone_damage, data = het_dataNSGG4, 
        main = "Heterocigosidad Observada por Fenotipo 5 Grupos Geneticos con AP", 
        xlab = "Fenotipo", 
        ylab = "Heterocigosidad Observada", 
        col = c("lightblue", "lightgreen"))  # Cambia los colores si lo prefieres

```


```{r }

# Gráfico de dispersión de heterocigosidad por individuo
plot(het_dataNSGG4$H_obs, 
     main = "Heterocigosidad Observada por Fenotipo 5 Grupos Geneticos con AP", 
     xlab = "Individuo", 
     ylab = "Heterocigosidad Observada", 
     pch = 16, 
     col = "blue")

```

```{r }


het_dataNSGG4AP <- het_data %>%
  filter(GroupMatrix != "No_sequenced" & 
         GroupMatrix != "P3y4_groupF" & 
         treatment != "purified_air")

# Verificar el resultado
head(het_dataNSGG4AP)

```


```{r }
# Graficar la heterocigosidad observada por fenotipo
boxplot(H_obs ~ ozone_damage, data = het_dataNSGG4AP, 
        main = "Heterocigosidad Observada por Fenotipo 5 Grupos Geneticos sin AP", 
        xlab = "Fenotipo", 
        ylab = "Heterocigosidad Observada", 
        col = c("lightblue", "lightgreen"))  # Cambia los colores si lo prefieres

```

```{r }

# Gráfico de dispersión de heterocigosidad por individuo
plot(het_dataNSGG4AP$H_obs, 
     main = "Heterocigosidad Observada por Fenotipo 5 Grupos Geneticos sin AP", 
     xlab = "Individuo", 
     ylab = "Heterocigosidad Observada", 
     pch = 16, 
     col = "blue")

```

```{r }
# Graficar la heterocigosidad observada por Grupo Genetico
boxplot(H_obs ~ GroupMatrix, data = het_dataNSGG4AP, 
        main = "Heterocigosidad Observada por Grupo Genetico", 
        xlab = "Fenotipo", 
        ylab = "Heterocigosidad Observada", 
        col = c("lightblue", "lightgreen"))  # Cambia los colores si lo prefieres

```



```{r }

# Crear un vector de colores según el fenotipo o grupo
colores <- as.factor(het_dataNSGG4AP$ozone_damage)  # o 'fenotipo', si es la columna que tienes

# Graficar, usando colores distintos para cada grupo
plot(het_dataNSGG4AP$H_obs, 
     main = "Heterocigosidad Observada por Fenotipo 5 Grupos Geneticos sin AP", 
     xlab = "Individuo", 
     ylab = "Heterocigosidad Observada", 
     pch = 16, 
     col = colores)


```


# Modelo considerando HETEROCIGOSIDAD

#Modelo delta Altura SIN purificados

```{r }
# Prueba con distintas familias
fig_gaussian <- ggplot(het_dataNSGG4AP, aes(x = H_obs, y = delta_altura, color = ozone_damage)) +
  geom_point(alpha = 0.5, size = 2.5) +
  geom_smooth(method = "glm", method.args = list(family = gaussian(link = "identity")), fullrange = TRUE) +
  labs(title = "GLM con Gaussian", x = "Heterocigosidad", y = "Delta Altura") +
  theme_bw()

fig_gamma <- ggplot(het_dataNSGG4AP, aes(x = H_obs, y = delta_altura, color = ozone_damage)) +
  geom_point(alpha = 0.5, size = 2.5) +
  geom_smooth(method = "glm", method.args = list(family = Gamma(link = "log")), fullrange = TRUE) +
  labs(title = "GLM con Gamma", x = "Heterocigosidad", y = "Delta Altura") +
  theme_bw()

fig_inverse_gaussian <- ggplot(het_dataNSGG4AP, aes(x = H_obs, y = delta_altura, color = ozone_damage)) +
  geom_point(alpha = 0.5, size = 2.5) +
  geom_smooth(method = "glm", method.args = list(family = inverse.gaussian(link = "log")), fullrange = TRUE) +
  labs(title = "GLM con Inverse Gaussian", x = "Heterocigosidad", y = "Delta Altura") +
  theme_bw()

# Mostrar los gráficos
print(fig_gaussian)
print(fig_gamma)
print(fig_inverse_gaussian)


model_gaussian <- glm(delta_altura ~ H_obs, data = het_dataNSGG4AP, family = gaussian(link = "identity"))
model_gamma <- glm(delta_altura ~ H_obs, data = het_dataNSGG4AP, family = Gamma(link = "log"))
model_inverse_gaussian <- glm(delta_altura ~ H_obs, data = het_dataNSGG4AP, family = inverse.gaussian(link = "log"))

# Comparar AIC de los modelos
AIC(model_gaussian, model_gamma, model_inverse_gaussian)

```

```{r }

#Distribución Exponencial o Gamma (Gamma): Si los datos son continuos, no negativos, y asimétricos.

#delta_altura = cambio de altura antes y despues del Tratamiento con dosis de ozono
#ozone_damage = Fenotipo Sintomatico o Asintomatico antes y despues del Tratamiento con dosis de ozono
#Treatment = Dosis de ozono a la que se expusieron los arboles por 3 meses
#GroupMatrix = Grupo genetico al que se asociaron de acuerdo a un analisis de parentesco
#ChamberNumber = se refiere a la camara en la que se encontraban los arboles, cada tratamiento tenia 3 diferentes


# Convertir ozone_damage a factor (si es apropiado tratarlo como categoría)
het_dataNSGG4AP$ozone_damage <- factor(het_dataNSGG4AP$ozone_damage)

# Crear el gráfico
g0 <- ggplot(het_dataNSGG4AP, aes(x = H_obs, y = delta_altura))

fig5all <- g0 + 
  geom_point(aes(colour = ozone_damage, shape = ozone_damage), alpha = 0.5, size = 2.5) + 
  ylim(0, 22) + 
  geom_smooth(method = "glm", method.args = list(family = Gamma(link = "log")), aes(color = ozone_damage), fullrange = T) + 
  labs(x = "Heterocigosity", y = "Delta height") + 
  theme_bw()

fig5all

```


```{r }
# Model all independent variables WITH health status interaction 


glm_1<-glm(delta_altura ~ H_obs, data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_1)


glm_2<-glm(delta_altura ~ H_obs + ozone_damage, data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_2)



glm_3<-glm(delta_altura ~ H_obs + treatment, data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_3)



glm_4<-glm(delta_altura ~ H_obs + GroupMatrix, data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_4)


glm_5<-glm(delta_altura ~ H_obs + treatment + GroupMatrix, data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_5)

glm_6<-glm(delta_altura ~ H_obs + ozone_damage + GroupMatrix, data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_6)


glm_7<-glm(delta_altura ~ H_obs + ozone_damage + treatment, data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_7)


glm_8<-glm(delta_altura ~ H_obs + ozone_damage + treatment + GroupMatrix, data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_8)


glm_9<-glmer(delta_altura ~ H_obs + (1|GroupMatrix), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_9)


glm_10<-glmer(delta_altura ~ H_obs + ozone_damage + (1|GroupMatrix), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_10)



glm_11<-glmer(delta_altura ~ H_obs + treatment + (1|GroupMatrix), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_11)



glm_12<-glmer(delta_altura ~ H_obs + GroupMatrix + (1|GroupMatrix), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_12)


glm_13<-glmer(delta_altura ~ H_obs + treatment + GroupMatrix + (1|GroupMatrix), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_13)

glm_14<-glmer(delta_altura ~ H_obs + ozone_damage + GroupMatrix + (1|GroupMatrix), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_14)


glm_15<-glmer(delta_altura ~ H_obs + ozone_damage + treatment + (1|GroupMatrix), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_15)



glm_16<-glmer(delta_altura ~ H_obs + ozone_damage + treatment + GroupMatrix + (1|GroupMatrix), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_16)


glm_17<-glmer(delta_altura ~ H_obs + (1|GroupMatrix/treatment), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_17)


glm_18<-glmer(delta_altura ~ H_obs + ozone_damage + (1|GroupMatrix/treatment), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_18)

glm_19<-glmer(delta_altura ~ H_obs + ozone_damage + treatment + (1|GroupMatrix/treatment), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_19)

glm_20<-glmer(delta_altura ~ H_obs + ozone_damage + GroupMatrix + (1|GroupMatrix/treatment), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_20)

glm_21<-glmer(delta_altura ~ H_obs + ozone_damage + treatment+  GroupMatrix +(1|GroupMatrix/treatment), data = het_dataNSGG4AP, family = Gamma(link = "log"))
summary(glm_21)

# Comparar los AIC de los dos modelos
AIC(glm_1, glm_2, glm_3, glm_4, glm_5,
    glm_6, glm_7, glm_8, glm_9, glm_10,
    glm_11, glm_12, glm_13, glm_14, glm_15,
    glm_16, glm_17, glm_18, glm_19, glm_20,
    glm_21)


```


```{r }

```


#Modelo delta Altura SIN purificados

```{r }
df_JunDel_2Rel_filtradoAP <- df_JunDel_2Rel_filtrado %>%
  filter(treatment != "purified_air")                             

hist(df_JunDel_2Rel_filtradoAP$delta_altura, main="Histograma", xlab="Valores", col="lightblue", border="black")

#Distribución Exponencial o Gamma (Gamma): Si los datos son continuos, no negativos, y asimétricos (con cola a la derecha).

#delta_altura = cambio de altura antes y despues del Tratamiento con dosis de ozono
#ozone_damage = Fenotipo Sintomatico o Asintomatico antes y despues del Tratamiento con dosis de ozono
#Treatment = Dosis de ozono a la que se expusieron los arboles por 3 meses
#GroupMatrix = Grupo genetico al que se asociaron de acuerdo a un analisis de parentesco
#ChamberNumber = se refiere a la camara en la que se encontraban los arboles, cada tratamiento tenia 3 diferentes

      
model1 <- glm(delta_altura ~ ozone_damage, data = df_JunDel_2Rel_filtradoAP, family = inverse.gaussian(link = "log"))
summary(model1)

model2 <- glm(delta_altura ~ ozone_damage + treatment, data = df_JunDel_2Rel_filtradoAP, family = inverse.gaussian(link = "log"))
summary(model2)

model3 <- glm(delta_altura ~ ozone_damage +  GroupMatrix, data = df_JunDel_2Rel_filtradoAP, family = inverse.gaussian(link = "log"))
summary(model3)

#model4 <- glm(delta_altura ~ ozone_damage + treatment + GroupMatrix, data = #df_JunDel_2Rel_filtradoAP, family = inverse.gaussian(link = "log"))
#summary(model4)

model5 <- glmer(delta_altura ~ ozone_damage + treatment + GroupMatrix + (1|GroupMatrix) , data = df_JunDel_2Rel_filtradoAP, family = inverse.gaussian(link = "log"))
summary(model5)

model5 <- glmer(delta_altura ~ ozone_damage + treatment + GroupMatrix + (1|treatment) , data = df_JunDel_2Rel_filtradoAP, family = inverse.gaussian(link = "log"))
summary(model5)


model6 <- glmer(delta_altura ~ ozone_damage + treatment  + (1|treatment) , data = df_JunDel_2Rel_filtradoAP, family = inverse.gaussian(link = "log"))
summary(model6)


model7 <- glmer(delta_altura ~ ozone_damage + treatment + (1|GroupMatrix/treatment) , data = df_JunDel_2Rel_filtradoAP, family = inverse.gaussian(link = "log"))
summary(model7)


# Comparar los AIC de los dos modelos
AIC(model1, model2, model3, model5, model6, model7)

# Summaries
summary(model1)
summary(model2)
summary(model3)
#summary(model4)
summary(model5) 
summary(model6)
summary(model7)



```






